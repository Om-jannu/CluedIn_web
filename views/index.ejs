<%- include('templates/header'); %>

    <body class="hold-transition dark-mode sidebar-mini layout-fixed layout-navbar-fixed layout-footer-fixed">
        <div class="wrapper">

            <!-- Preloader -->
            <div class="preloader flex-column justify-content-center align-items-center">
                <img class="animation__shake" src="dist/img/CluedIn.png" alt="DBIT" height="120" width="412">
            </div>

            <!-- Navbar -->
            <%- include('templates/navbar'); %>
                <!-- /.navbar -->

                <!-- Main Sidebar Container -->
                <%- include('templates/sidebar'); %>

                    <!-- Content Wrapper. Contains page content -->
                    <div class="content-wrapper">
                        <!-- Content Header (Page header) -->
                        <div class="content-header">
                            <div class="container-fluid">
                                <div class="row mb-2">
                                    <div class="col-sm-6">
                                        <h1 class="m-0">Notification </h1>
                                    </div><!-- /.col -->
                                    <div class="col-sm-6">
                                        <ol class="breadcrumb float-sm-right">
                                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                                            <li class="breadcrumb-item active">DBIT Dashboard</li>
                                        </ol>
                                    </div><!-- /.col -->
                                </div><!-- /.row -->
                            </div><!-- /.container-fluid -->
                        </div>
                        <!-- /.content-header -->





                        <!-- Main content -->
                        <section class="content">
                            <div class="container-fluid">

                                <!-- Nav Tabs inside card header -->

                                <div class="card card-primary card-tabs">
                                    <div class="card-header p-0 pt-1">
                                        <ul class="nav nav-tabs" id="custom-tabs-two-tab" role="tablist">
                                            <!-- <li class="pt-2 px-3">
                                            <h3 class="card-title">Card Title</h3>
                                             </li> -->
                                            <li class="nav-item">
                                                <a class="nav-link active" id="custom-tabs-two-home-tab"
                                                    data-toggle="pill" href="#create-notification" role="tab"
                                                    aria-controls="custom-tabs-two-home" aria-selected="true">Create</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="custom-tabs-two-profile-tab" data-toggle="pill"
                                                    href="#listNotif" role="tab" aria-controls="custom-tabs-two-profile"
                                                    aria-selected="false">List
                                                    Notification</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="custom-tabs-two-messages-tab" data-toggle="pill"
                                                    href="#custom-tabs-two-messages" role="tab"
                                                    aria-controls="custom-tabs-two-messages"
                                                    aria-selected="false">Scheduled</a>
                                            </li>

                                        </ul>
                                    </div>

                                    <div class="card-body">
                                        <div class="tab-content" id="custom-tabs-two-tabContent">
                                            <div class="tab-pane fade active show" id="create-notification"
                                                role="tabpanel" aria-labelledby="custom-tabs-two-home-tab">
                                                <span id="#success1">
                                                    <% if(message1.length>0){ %>


                                                        <div class="alert alert-success alert-dismissible fade show"
                                                            role="alert">
                                                            <%= message1 %>
                                                                <button type="button" class="close" data-dismiss="alert"
                                                                    aria-label="Close">
                                                                    <span aria-hidden="true">&times;</span>
                                                                </button>
                                                        </div>

                                                        <% } %>
                                                            <% if(err_message1.length>0){ %>


                                                                <div class="alert alert-danger alert-dismissible fade show"
                                                                    role="alert">
                                                                    <%= err_message1 %>
                                                                        <button type="button" class="close"
                                                                            data-dismiss="alert" aria-label="Close">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                </div>

                                                                <% } %>
                                                </span>
                                                <!-- creating form -->
                                                <form id="quickform" name="notif-form" method="post" action="/sendNotif"
                                                    enctype="multipart/form-data">
                                                    <!--action looks for index.html -->
                                                    <div class="card-body">
                                                        <div class="form-group">
                                                            <label for="notificationTitle">Notification Title
                                                                *</label>
                                                            <input type="text" class="form-control"
                                                                id="notificationTitle" placeholder="Enter title"
                                                                name="notif_title" maxlength="30" required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Description *</label>
                                                            <textarea class="form-control" rows="3" name="notif_desc"
                                                                placeholder="Enter ..." required></textarea>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Schedule:</label>
                                                            <div class="input-group date" id="reservationdate"
                                                                data-target-input="nearest" style="width: 40%;">
                                                                <input type="date"
                                                                    class="form-control datetimepicker-input"
                                                                    data-target="#reservationdate" name="scheduled_date"
                                                                    id="notifMsgScheduleDate"
                                                                    onclick="notifMsgScheduleHandler();">
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Expiry Date:</label>
                                                            <div class="input-group date" id="reservationdate"
                                                                data-target-input="nearest" style="width: 40%;">
                                                                <input type="date"
                                                                    class="form-control datetimepicker-input"
                                                                    data-target="#reservationdate" name="scheduled_date"
                                                                    id="notifMsgExpiryDate"
                                                                    onclick="notifMsgExpiryHandler();">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-lg-6">
                                                                <div class="form-group">


                                                                    <label>Target Class (*press ctrl key to
                                                                        select
                                                                        multiple
                                                                        fields)</label>
                                                                    <select style="height: 15rem;width:15rem ;"
                                                                        class="form-control" tabindex="-1" id="slct1"
                                                                        aria-hidden="true" name="target_class[]"
                                                                        placeholder="select category" onchange=""
                                                                        multiple required>

                                                                        <option id="allUsers" value="0">
                                                                            ALL
                                                                        </option>
                                                                        <% for (let count=0; count < bsd_data.length;
                                                                            count++) { %>
                                                                            <option
                                                                                value="<%= bsd_data[count].bsd_id %>">
                                                                                <%= bsd_data[count].bsd_value %>
                                                                            </option>
                                                                            <%} %>
                                                                    </select>

                                                                </div>
                                                            </div>
                                                            <div class="col-lg-6">
                                                                <h4>Target Audience: <strong><span id="targetAudience">
                                                                        </span></strong></h4>
                                                            </div>
                                                        </div>


                                                        <div class="form-group">
                                                            <label>Gender</label>
                                                            <select class="form-control " style="width: 15rem;"
                                                                tabindex="-1" id="slct2" aria-hidden="true"
                                                                name="user_gender" placeholder="select Gender" required>
                                                                <option selected="selected" value="0">
                                                                    All
                                                                </option>
                                                                <option value="1">
                                                                    Male
                                                                </option>
                                                                <option value="2">Female</option>
                                                                <option value="3">Other</option>
                                                            </select>

                                                        </div>

                                                        <div class="row">
                                                            <div class="col-lg-4">
                                                                <div class="form-group">
                                                                    <label>Label</label>
                                                                    <select class="form-control " style="width: 15rem;"
                                                                        tabindex="-1" aria-hidden="true" name="label"
                                                                        placeholder="select label type" id="notifLabel"
                                                                        required>
                                                                        <% for (let count=0; count < label_data.length;
                                                                            count++) { %>
                                                                            <option
                                                                                value="<%= label_data[count].label_id %>">
                                                                                <%= label_data[count].label_name %>
                                                                            </option>
                                                                            <%} %>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-lg-4">
                                                                <div class="form-group">
                                                                    <label>Image URL:</label>
                                                                    <div class="input-group " style="width: 100%; ">
                                                                        <input type="file" name="notif-img"
                                                                            class="form-control"
                                                                            accept=".jpep,.png,.jpg" id="notifImgUrl"
                                                                            onchange="preview_notifImg_handler(event)">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-lg-4">
                                                                <div class="form-group">
                                                                    <label>Attachement URL:</label>
                                                                    <div class="input-group " style="width: 100%; ">
                                                                        <input type="file" name="notif-attachment"
                                                                            class="form-control" accept=".doc,.pdf"
                                                                            id="notifAttachmentUrl">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-lg-4">
                                                                <div class="form-group">
                                                                    <label>Registration Link:</label>
                                                                    <div class="input-group " style="width: 100%; ">
                                                                        <input type="url" class="form-control"
                                                                            id="notifRegistrationUrl"
                                                                            placeholder="registration url"
                                                                            name="notif_reg_url">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-footer">
                                                        <button type="submit"
                                                            class="btn btn-primary">SendNotification</button>
                                                    </div>
                                                </form>
                                            </div>

                                            <!--OM YAHA  DAAL FORM  -->
                                            <div class="tab-pane fade" id="listNotif" role="tabpanel"
                                                aria-labelledby="custom-tabs-two-profile-tab">

                                                <!-- inside list notif div  -->
                                                <div class="card">
                                                    <div class="card-body table-responsive p-0 container-fluid"
                                                        style="height: 100%;">
                                                        <table style="width: 100%;" class="table table-head-fixed"
                                                            id="notif_table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Title</th>
                                                                    <th>Message</th>
                                                                    <th>Category</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>

                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tab-pane fade" id="custom-tabs-two-messages" role="tabpanel"
                                                aria-labelledby="custom-tabs-two-messages-tab">
                                                <h3>Work Under Construction!!!</h3>
                                                <div class="card">
                                                    <div class="card-body table-responsive p-0 container-fluid"
                                                        style="height: 100%;">
                                                        <table style="width: 100%;" class="table table-head-fixed"
                                                            id="notif_schedule_table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Title</th>
                                                                    <th>Message</th>
                                                                    <th>Category</th>
                                                                    <th>Scheduled Date</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>

                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <!-- Modal-->
                                <div class="modal" id="exampleModal" tabindex="-1" role="dialog"
                                    aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel">Class has 0 count</h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                Please select a class with a non-zero count.
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <!-- Main Footer -->
                                <footer class="main-footer">
                                    <strong>Copyright &copy; 2022-2023 <a href="">CluedIn</a>.</strong>
                                    All rights reserved.
                                    <div class="float-right d-none d-sm-inline-block">
                                        <b>Version</b> 1.0.0
                                    </div>
                                </footer>
                            </div>
                        </section>
                        <!-- ./wrapper -->

                        <!-- REQUIRED SCRIPTS -->
                        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
                        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
                            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
                            crossorigin="anonymous"></script>
                        <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
                        <script src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>
                        <!-- jQuery -->
                        <!-- <script src="plugins/jquery/jquery.min.js"></script> -->
                        <!-- Bootstrap -->
                        <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
                        <!-- overlayScrollbars -->
                        <script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
                        <!-- AdminLTE App -->
                        <script src="dist/js/adminlte.js"></script>

                        <!-- PAGE PLUGINS -->
                        <!-- jQuery Mapael -->
                        <script src="plugins/jquery-mousewheel/jquery.mousewheel.js"></script>
                        <script src="plugins/raphael/raphael.min.js"></script>
                        <script src="plugins/jquery-mapael/jquery.mapael.min.js"></script>
                        <script src="plugins/jquery-mapael/maps/usa_states.min.js"></script>
                        <!-- ChartJS -->
                        <script src="plugins/chart.js/Chart.min.js"></script>

                        <!-- AdminLTE for demo purposes -->
                        <script src="dist/js/demo.js"></script>
                        <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
                        <script src="dist/js/pages/dashboard2.js"></script>
                        <!-- <script src="./plugins/jquery/jquery.min.js"></script> -->



                        <script>
                            var dataTable = $('#notif_table');
                            $(document).ready(function () {
                                console.log('reached here in ejs');
                                // var dataTable = $('#notif_table');
                                dataTable.DataTable({
                                    'processing': true,
                                    'serverSide': true,
                                    'lengthMenu': [
                                        [7, 10, 25, 50, -1],
                                        [7, 10, 25, 50],
                                    ],
                                    'serverMethod': 'get',
                                    'ajax': {
                                        'url': "/action"
                                    },
                                    'aaSorting': [],
                                    'columns': [
                                        { data: 'nm_title' },
                                        { data: 'nm_message' },
                                        // { data : 'dateOfExpiration' },
                                        // { data : 'scheduled_date' },
                                        { data: 'label_name' },

                                    ]
                                });
                            });

                                // function preview_notifImg_handler(event){
                                //     let notif_img = URL.createObjectURL(event.target.files[0]);
                                //     let preview_img_div = document.getElementById("preview_notif_img_div");
                                //     let preview_img = document.createElement("img");
                                //     preview_img.src = notif_img;
                                //     preview_img_div.appendChild(preview_img);
                                // }

                        </script>
                        <script>
                            $(document).ready(function () {
                                let span = $('#success1')
                                console.log("spantag", span);
                                console.log("seccess111");
                                setTimeout(function () {
                                    console.log("inside timeout");
                                    $("#success1").html('');
                                }, 3000);
                            });
                            // $(document).ready(function () {
                            //     console.log("seccess111");
                            //     setTimeout(function () {
                            //         console.log("inside timeout");
                            //         $("#success1").css('visibility','hidden');
                            //     }, 3000);
                            // });
                        </script>

                        <script>
                        //     const dropdown = document.querySelector('#slct1');
                        //     const genderDropdown = document.querySelector('#slct2')
                        //     const selectedOptions = [];
                        //     const targetAudienceSpan = document.querySelector('#targetAudience');

                        //     dropdown.addEventListener('change', (event) => {

                        //         // Update count of students for selected classes
                        //         // updateCount(selectedOptions);
                        //         const selectedOptions = Array.from(event.target.selectedOptions);
                        //         const selectedClasses = selectedOptions.map(option => option.value);
                        //         console.log("slctoptions", selectedClasses);
                        //         fetch(`/targetCount?classes=${selectedClasses.join(',')}`)
                        //             .then(response => response.json())
                        //             .then(data => {
                        //                 // Extract count of students from response and store in counts object
                        //                 console.log("fetchdata", data);
                        //                 // counts[classCode] = data.count;

                        //                 // Update count display
                        //                 targetAudienceSpan.textContent = data.totalStudents;
                        //             });
                        //     });
                        //     function updateCount(selectedOptions) {
                        //         // Retrieve count of students for each selected class
                        //         const counts = {};

                        //         const bsd_id = selectedOptions;
                        //         // Use AJAX or fetch to retrieve count of students for each class
                        //         // and store it in the counts object
                        //         fetch(`/targetCount??classes=${selectedClasses.join(',')}`)
                        //             .then(response => response.json())
                        //             .then(data => {
                        //                 // Extract count of students from response and store in counts object
                        //                 console.log("fetchdata", data);
                        //                 counts[classCode] = data.count;

                        //                 // Update count display
                        //                 const countDisplay = document.querySelector('#targetAudience');
                        //                 countDisplay.innerHTML = '';
                        //                 for (let classCode in counts) {
                        //                     countDisplay.innerHTML += `${classCode}: ${counts[classCode]}<br>`;
                        //                 }
                        //             });

                        //         console.log("count", selectedOptions);

                        //         // Update count display
                        //         const countDisplay = document.querySelector('#count-display');
                        //         countDisplay.innerHTML = '';
                        //         for (let classCode in counts) {
                        //             countDisplay.innerHTML += `${classCode}: ${counts[classCode]}<br>`;
                        //         }
                        //     }
                        //     // $(document).ready(function () {

                        //     //     load_data();
                        //     //     function load_data() {
                        //     //         console.log("data");
                        //     //         $.ajax({
                        //     //             url: "/targetCount",
                        //     //             method: "POST",
                        //     //             data: { action: 'fetch' },
                        //     //             dataType: "JSON",
                        //     //             success: function (data) {
                        //     //                 console.log("dataaaa:", data);
                        //     //                 var html = '';

                        //     //                 if (data.data.length > 0) {
                        //     //                     html += `  1000                                       `;
                        //     //                 }


                        //     //                 $('targetAudience').html(html);
                        //     //                 // console.log(html);

                        //     //             }
                        //     //         });
                        //     //     }
                        //     // })
                        </script>

                        <script>
                            const classDropdown = document.querySelector('#slct1');
                            const genderDropdown = document.querySelector('#slct2');

                            const targetAudienceSpan = document.querySelector('#targetAudience');

                            classDropdown.addEventListener('change', updateCount);
                            genderDropdown.addEventListener('change', updateCount);

                            function updateCount() {
                                // Retrieve selected classes and gender
                                console.log("genderdrop", genderDropdown);
                                const selectedClasses = Array.from(classDropdown.selectedOptions).map(option => option.value);
                                console.log("logg", selectedClasses);
                                const selectedGender = genderDropdown.value;
                                console.log("gender", selectedGender);

                                // Use fetch to retrieve count of students for selected classes and gender
                                if (selectedClasses.length > 0 && selectedGender.length > 0) {
                                    fetch(`/targetCount?classes=${selectedClasses.join(',')}&genderCode=${selectedGender}`)
                                        .then(response => response.json())
                                        .then(data => {
                                            // Update count display
                                            targetAudienceSpan.textContent = data.totalStudents;
                                        });
                                } else {
                                    // If no options are selected, display a count of 0
                                    targetAudienceSpan.textContent = '0';
                                }
                            }

                            const form = document.querySelector('#quickform');
                            // const targetAudienceSpan = document.querySelector('#targetAudience');

                            form.addEventListener('submit', (event) => {
                                const targetAudienceCount = parseInt(targetAudienceSpan.textContent);
                                if (targetAudienceCount === 0) {
                                    event.preventDefault();
                                    showModal('Class has 0 count');
                                }
                            });

                            function showModal(message) {
                                const modalBody = document.querySelector('.modal-body');
                                modalBody.textContent = message;

                                const modal = new bootstrap.Modal(document.querySelector('#exampleModal'), {
                                    keyboard: false,
                                    backdrop: 'static'
                                });
                                modal.show();
                            }

                        </script>

                        <!-- function for sub category in notif form  -->

                        <script>

                            function disableOptions() {
                                var dropdown = document.getElementById("slct1");
                                var options = dropdown.options;
                                var selectedIndex = dropdown.selectedIndex;


                                if (options[0].value == 0) {
                                    for (var i = 1; i < options.length; i++) {
                                        if (i != selectedIndex) {
                                            options[i].disabled = true;
                                        }
                                    }
                                } else {
                                    for (var i = 0; i < options.length; i++) {
                                        options[i].disabled = false;
                                    }
                                }
                                // if (document.getElementById("allUsers").disabled == false) {
                                //     for (var i = 0; i < options.length; i++) {
                                //         if (i != selectedIndex) {
                                //             options[i].disabled = false;
                                //         }
                                //     }
                                // }

                                document.getElementById("slct1").addEventListener("change", function () {
                                    var dropdown = document.getElementById("slct1");
                                    var options = dropdown.options;
                                    var selectedIndex = dropdown.selectedIndex;
                                    console.log("Inside event listener ");

                                    if (options[0].value != 0) {
                                        for (var i = 1; i < options.length; i++) {
                                            options[i].disabled = false;
                                        }
                                    }
                                });

                            }

                            function ScheduleDate() {
                                let todayDate = new Date();
                                let month = todayDate.getMonth() + 1;
                                let year = todayDate.getUTCFullYear();
                                let tdate = todayDate.getDate();
                                if (tdate < 10) {
                                    tdate = "0" + tdate;
                                }
                                if (month < 10) {
                                    month = "0" + month;
                                }
                                let minDate = year + "-" + month + "-" + tdate;
                                return minDate;
                            }
                            function notifLabelHandler() {
                                if (document.getElementById("notifLabel").value == 5) {
                                    document.getElementById("notifEventSchedule").style.visibility = "visible";
                                } else {
                                    notifEventSchedule.style.visibility = "hidden";
                                }
                            }
                            function notifMsgScheduleHandler() {
                                let minDate = ScheduleDate();
                                document.getElementById("notifMsgScheduleDate").setAttribute("min", minDate);
                            }
                            function notifMsgExpiryHandler() {
                                document.getElementById("notifMsgExpiryDate").setAttribute("min", document.getElementById("notifMsgScheduleDate").value);
                            }
                        </script>

    </body>

    </html>